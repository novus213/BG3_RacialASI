--[[
___________              __                   __  .__              .__       _____        .__   __  .__
\_   _____/____    _____/  |______    _______/  |_|__| ____ _____  |  |     /     \  __ __|  |_/  |_|__|__  __ ___________  ______ ____  
 |    __) \__  \  /    \   __\__  \  /  ___/\   __\  |/ ___\\__  \ |  |    /  \ /  \|  |  \  |\   __\  \  \/ // __ \_  __ \/  ___// __ \ 
 |     \   / __ \|   |  \  |  / __ \_\___ \  |  | |  \  \___ / __ \|  |__ /    Y    \  |  /  |_|  | |  |\   /\  ___/|  | \/\___ \\  ___/ 
 \___  /  (____  /___|  /__| (____  /____  > |__| |__|\___  >____  /____/ \____|__  /____/|____/__| |__| \_/  \___  >__|  /____  >\___  >
     \/        \/     \/          \/     \/               \/     \/               \/                              \/           \/     \/ 
      \_Fantastical Multiverse 1.5.9.2 Used
Argelia source Mixed

]]--


--Maybe move the table to external JSON later(?)
local fantasticalTable = {
    FantasticalCreatures = {
        FloatingSources = {
            {
                Name = "Fantastical Astral Elf",
                modGuid = "e7071309-78a8-4fad-949b-d4dd326dd39b",
                Source = "Spelljammer: Adventures in Space",
                UUID = "06e918ad-be2c-48b6-a098-0288539de744"
            },
            {
                Name = "Fantastical Reborn(Humanoid)",
                modGuid = "07a0478e-ba76-4fc7-a671-1c13c66ede2e",
                Source = "Van Richten's Guide to Ravenloft",
                UUID = "1253592f-5c8b-41b5-9ae7-b83b08ab92bb"
            },
            {
                Name = "Fantastical Downcast",
                modGuid = "21d14d75-2e99-4e85-82ad-7139c69b85fe",
                Source = "Grim Hollow's Player's Guide",
                UUID = "aa03e8ed-a301-4e4a-bfde-ff7144e1fbb1"
            },
            {
                Name = "Fantastical Elezen",
                modGuid = "3b7799fa-3dc0-47da-bf9f-fc590f7e2cdf",
                Source = "Eorzea (FFXIV X Dungeons & Souls)",
                UUID = "9be04b6b-c89f-4e67-8431-d0cd9b97db15"
            },
            {
                Name = "Fantastical Dhampir(Lineage)",
                modGuid = "f34c3aca-0b14-4001-af29-27e130cf5c5c",
                Source = "Van Richten's Guide to Ravenloft",
                UUID = "de9b4cc2-94af-46d8-ab7d-31b00d81df03"
            },
            {
                Name = "Fantastical Orc",
                modGuid = "9cbbf22a-2af4-48c7-970a-fb61a6c20b15",
                Source = "Player's Handbook (2024)",
                UUID = "6c7094a4-bc8c-4613-9de6-5d9edec8e403"
            },
            {
                Name = "Fantastical Kender",
                modGuid = "4508d3bd-e721-47a4-894d-0e61c7b0380d",
                Source = "Dragonlance: Shadow of the Dragon Queen",
                UUID = "727ce5d7-2c90-4cbb-bd52-6bd45067e27b"
            },
            {
                Name = "Fantastical Water Genasi",
                modGuid = "95d5279b-e063-459d-81d2-d4fa0cec27ca",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "43759dcb-f50f-4c22-906c-d79c40a3dbb0"
            },
            {
                Name = "Fantastical Shadar-kai",
                modGuid = "6abf0f64-62d6-4e80-a141-5582e29783e7",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "24991da3-14d0-4c65-85c6-9c62168415eb"
            },
            {
                Name = "Fantastical Air Genasi",
                modGuid = "35fd2505-5eff-45c5-96e9-98d848f35da4",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "58af38d8-b039-4a75-91fa-4ef079318d8b"
            },
            {
                Name = "Fantastical Earth Genasi",
                modGuid = "3fe9bc5e-2723-4044-a06b-060aed98e40b",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "47372143-e2a7-4cc5-9810-7caea80bd46a"
            },
            {
                Name = "Fantastical Firbolg",
                modGuid = "2b5c5a5b-5da3-4c65-b852-92ff75dda75a",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "003cf78d-7db5-444e-9a2f-e41f9836c8c3"
            },
            {
                Name = "Fantastical Fire Genasi",
                modGuid = "410f1b65-e8a1-4f13-b4e8-ae25e5460a7e",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "5a33238e-313f-4cce-8bac-f36db533b704"
            },
            {
                Name = "Fantastical Githzerai",
                modGuid = "dc812cdf-7fdb-4372-81c7-72df0e00f542",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "8ffe5132-b5ad-424c-befb-eb4fc640a18b"
            },
            {
                Name = "Fantastical Goliath",
                modGuid = "ff15d50f-57d4-48d9-80ce-0ee75a669010",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "d3ca9791-8f41-4819-9e2e-5c3f6dfb7778"
            },
            {
                Name = "Fantastical Kobold",
                modGuid = "d41e6098-288c-49ba-a861-1ab082f8e4b9",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "9572fef0-12c6-4730-94ad-1471d54e7172"
            },
            {
                Name = "Fantastical Lizardfolk",
                modGuid = "44aeee6c-5a35-4733-89a1-420451c6a559",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "fc81b68e-2835-4791-8a22-bfedee977765"
            },
            {
                Name = "Fantastical Minotaur",
                modGuid = "35e9d7e9-716d-4fdb-8b0b-6dac2526389d",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "82319b4e-f38e-49b0-81cd-59953d54d824"
            },
            {
                Name = "Fantastical Sea Elf",
                modGuid = "13871336-692e-4af3-9e52-68cdf58330fb",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "08bcd922-ef05-49e0-8e6f-3f6574c4d54c"
            },
            {
                Name = "Fantastical Triton",
                modGuid = "41e6aeb8-e8ae-41b8-b303-8ad2f8b43f61",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "328aafb6-9e72-4702-b3ab-10bdbc5e953e"
            },
            {
                Name = "Fantastical Yuan-ti",
                modGuid = "bea5a09a-b394-4a52-9166-659cbc1bf183",
                Source = "Mordenkainen Presents: Monsters of the Multiverse",
                UUID = "3fbd5365-bb01-4741-965d-2be2f11156bd"
            },
            {
                Name = "Fantastical Ogresh",
                modGuid = "0cc2683d-c407-40d6-ad65-8c5f95d7ef4b",
                Source = "Grim Hollow's Player's Guide",
                UUID = "11d3fa5d-3e88-4c8c-b21c-e183d7208533"
            }
        },
        FixedSources = {
            {
                Name = "Fantastical Yuan-ti Pureblood",
                modGuid = "94710eae-8809-42fe-ab17-5681ceae8714",
                UUID = "69a8edff-fdec-4ef5-aeb6-dcb15562b062",
                Source = "Volo's Guide to Monsters (LEGACY)",
                Strings = {"Ability(Charisma,2)", "Ability(Intelligence,1)"}
            },
            {
                Name = "Fantastical Pallid Elf",
                modGuid = "02ad19d9-bb24-44a6-9693-35cec821774c",
                Source = "Explorer's Guide to Wildemount",
                UUID = "82704351-c1d6-4767-adef-49e25a290aad",
                Strings = {"Ability(Dexterity,2)", "Ability(Wisdom,1)"}
            },
            {
                Name = "Fantastical Vedalken",
                modGuid = "58474556-4b69-494d-b290-1421010d1742",
                UUID = "d17424ad-839d-4733-b16d-f7cb007c865f",
                Source = "Guildmasters' Guide to Ravnica",
                Strings = {"Ability(Intelligence,2)", "Ability(Wisdom,1)"}
            },
            {
                Name = "Fantastical Kobold Legacy",
                modGuid = "866dee81-42b5-4647-9fb7-ec39271f6c96",
                UUID = "ee0bbb70-b8f7-44ec-9419-565ab963f664",
                Source = "Volo's Guide to Monsters (LEGACY)",
                Strings = {"Ability(Dexterity,2)"}
            },
            {
                Name = "Fantastical Kalashtar",
                modGuid = "cbd0f091-d2a7-4569-bdf8-56511cea3076",
                UUID = "0e35ec74-a63c-4d24-8912-4afa4a9930d8",
                Source = "Volo's Guide to Monsters (LEGACY)",
                Strings = {"Ability(Wisdom,2)", "Ability(Charisma,1)"}
            },
            {
                Name = "Fantastical Bugbear",
                modGuid = "f4361c10-b197-4490-ae30-06ce796f950e",
                Source = "Volo's Guide to Monsters (LEGACY)",
                UUID = "d01d244f-3ae2-4d15-b0ba-9aed04fc16ac",
                Strings = {"Ability(Strength,2)", "Ability(Dexterity,1)"}
            }
        }
    },
    -- This part sis just for reference, not needed
    Sources = {
        Floating = {
            "Player's Handbook (2024)",
            "Player's Handbook (2014)",
            "Mordenkainen Presents: Monsters of the Multiverse",
            "Spelljammer: Adventures in Space",
            "Van Richten's Guide to Ravenloft",
            "Grim Hollow's Player's Guide",
            "Eorzea (FFXIV X Dungeons & Souls)",
            "MalipƒÅla Odyssey (Dungeons & Souls)",
            "Dragonlance: Shadow of the Dragon Queen"
        },
        Fixed = {
            "Volo's Guide to Monsters (LEGACY)",
            "Explorer's Guide to Wildemount",
            "Eberron: Rising from the Last War",
            "Guildmasters' Guide to Ravnica"
        }
    }
}

local Framework_FM_UUID = "ff9844a0-a097-4149-bbca-ee0da5b937d7"
local Framework_UUID = "67fbbd53-7c7d-4cfa-9409-6d737b4d92a9" -- CompatibilityFramework


-- Function to create the payload based on the entry and source type
local function createPayload(entry, sourceType)
    local payload = {
        modGuid = entry.modGuid,
        Target = entry.UUID,
        FileType = "Progression"
    }

    if sourceType == "FloatingSources" then
        payload.Function = "SelectAbilityBonus"
        payload.Params = {
            Guid = "b9149c8e-52c8-46e5-9cb6-fc39301c05fe",
            Amount = "2",
            BonusType = "AbilityBonus",
            Amounts = {"2", "1"}
        }
    elseif sourceType == "FixedSources" then
        payload.Type = "Boosts"
        payload.Strings = entry.Strings
    end

    return payload
end

-- Function to insert the payload into the appropriate API method
local function insertPayload(payload, sourceType)
    if sourceType == "FloatingSources" then
        Mods.SubclassCompatibilityFramework.Api.InsertSelectors({payload})
    elseif sourceType == "FixedSources" then
        Mods.SubclassCompatibilityFramework.Api.InsertBoosts({payload})
    end
end

-- Function to process the source table
local function processSources(sources, sourceType)
    local count = 0
    for _, entry in ipairs(sources) do
        if entry.modGuid and entry.UUID and Ext.Mod.IsModLoaded(entry.modGuid) then
            local payload = createPayload(entry, sourceType)
            insertPayload(payload, sourceType)
            count = count + 1
        end
    end
    return count
end

-- Function to be called when stats are loaded
local function FantasticalOnStatsLoaded()
    local totalPayloads = 0
    local fantasticalTypes = {"FloatingSources", "FixedSources"}

    for _, sourceType in ipairs(fantasticalTypes) do
        local sources = fantasticalTable.FantasticalCreatures[sourceType]
        local count = processSources(sources, sourceType)
        totalPayloads = totalPayloads + count
    end

    BasicPrint("___________              __                   __  .__              .__       _____        .__   __  .__                                  ","INFO", nil, nil, true)
    BasicPrint("\\_   _____/____    _____/  |______    _______/  |_|__| ____ _____  |  |     /     \\  __ __|  |_/  |_|__|__  __ ___________  ______ ____  ","INFO", nil, nil, true)
    BasicPrint(" |    __) \\__  \\  /    \\   __\\__  \\  /  ___/\\   __\\  |/ ___\\\\__  \\ |  |    /  \\ /  \\|  |  \\  |\\   __\\  \\  \\/ // __ \\_  __ \\/  ___// __ \\ ","INFO", nil, nil, true)
    BasicPrint(" |     \\   / __ \\|   |  \\  |  / __ \\_\\___ \\  |  | |  \\  \\___ / __ \\|  |__ /    Y    \\  |  /  |_|  | |  |\\   /\\  ___/|  | \\/\\___ \\\\  ___/ ","INFO", nil, nil, true)
    BasicPrint(" \\___  /  (____  /___|  /__| (____  /____  > |__| |__|\\___  >____  /____/ \\____|__  /____/|____/__| |__| \\_/  \\___  >__|  /____  >\\___  >","INFO", nil, nil, true)
    BasicPrint("     \\/        \\/     \\/          \\/     \\/               \\/     \\/               \\/                              \\/           \\/     \\/ ","INFO", nil, nil, true)
    BasicPrint("      \\\\_Fantastical Multiverse 1.5.9.2 Used","INFO", nil, nil, true)
    BasicWarning("============> Amount of Fantastical Mods reverted to original values: " .. totalPayloads)
end

-- Check if the mod is loaded and subscribe to the stats loaded event
if Ext.Mod.IsModLoaded(Framework_UUID) and Ext.Mod.IsModLoaded(Framework_FM_UUID) then
    Ext.Events.StatsLoaded:Subscribe(FantasticalOnStatsLoaded)
end
